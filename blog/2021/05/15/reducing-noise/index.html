<html>
  <head>
    <title>Reducing Noise - canhazdb</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/img/favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/atom-one-dark.min.css" integrity="sha512-Fcqyubi5qOvl+yCwSJ+r7lli+CO1eHXMaugsZrnxuU4DVpLYWXTVoHy55+mCb4VZpMgy7PBhV7IiymC0yu9tkQ==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js" integrity="sha512-zol3kFQ5tnYhL7PzGt0LnllHHVWRGt2bTCIywDiScVvLIlaDOVJ6sPdJTVi0m3rA660RT+yZxkkRzMbb1L8Zkw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/javascript.min.js" integrity="sha512-u9dJCEIlcxWLWzlBIBDAO98TI5r1yrxGwRY2vbqFdecd58lamsEgBt1p4sDNBncNUMDV5//WdywRHdhCLx0FJQ==" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/css/header.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />

    <script>
      document.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightBlock(block);
        });
      });

      function toggleBurgerMenu () {
        document.body.classList.toggle('burger-open');
      }
    </script>
    <base href="/" />

    <link rel="icon" type="image/png" href="/img/favicon.png" />
  </head>

  <body>
    <header class="menu-header">
      <div class="header-container">
        <div class="header-brand">
          <a href="/">
            <img src="/img/logo.svg" class="logo-icon" />
            <span>canhazdb</span>
          </a>
        </div>
        <div class="header-burger" onclick="toggleBurgerMenu()">
          <svg viewBox="0 0 100 80" width="25" height="25">
            <rect width="100" height="10"></rect>
            <rect y="30" width="100" height="10"></rect>
            <rect y="60" width="100" height="10"></rect>
          </svg>
        </div>
        
    <nav class="bugerable">
      <a href="/" false>Home</a>
      <a href="/docs" false>Docs</a>
      <a href="/blog" class="active">Blog</a>
      <a href="https://github.com/canhazdb/server/discussions">Community</a>
    </nav>
  
      </div>
    </header>

    <main>
      <div class="with-sidebar"><div class="thin content"><sidebar><ul><li><span>October 2021</span><ul><li><span>1</span><a href="/blog/2021/09/01/conflicts">Conflicts</a></li></ul></li><li><span>August 2021</span><ul><li><span>15</span><a href="/blog/2021/07/15/notify-and-license">Notify and license</a></li><li><span>11</span><a href="/blog/2021/07/11/ha-update">Ha update</a></li></ul></li><li><span>June 2021</span><ul><li><span>15</span><a href="/blog/2021/05/15/reducing-noise">Reducing noise</a></li><li><span>5</span><a href="/blog/2021/05/05/performance-bug">Performance bug</a></li><li><span>1</span><a href="/blog/2021/05/01/websockets-insert">Websockets insert</a></li></ul></li><li><span>May 2021</span><ul><li><span>23</span><a href="/blog/2021/04/23/stability">Stability</a></li></ul></li><li><span>February 2021</span><ul><li><span>8</span><a href="/blog/2021/01/08/introduction">Introduction</a></li></ul></li></ul></sidebar><section><div class="content-heading"><h1 id="Reducing Noise"><a href="/blog/#Reducing Noise">Reducing Noise</a><small>Published by <a href="https://markwylde.com" target="_blank">Mark Wylde</a> on 2021-06-15</small></h1><div class="content-info"><a target="_blank" class="edit-page" href="https://github.com/canhazdb/documentation/blob/master/content/blog/2021-06-15-reducing-noise.md">Edit this page</a><em>Last updated: 2021-10-02</em></div></div><div><p>I&#39;ve been wanted to get high availability into canhazdb for quite a while now, but I had been unsure of exactly how I was going to implement it.</p>
<p>There&#39;s still some unknowns, but in general I feel I&#39;ve got a good idea of where I want it to go.</p>
<p>This week I started a new branch, which is essentially a complete rewrite of the server.</p>
<p>Some major changes are in that branch:</p>
<h2 id="no-httpswss-servers">No http(s)/ws(s) servers</h2>
<p>When I wrote the first version, I kept juggling between the http(s) server, and the tcp servers. I decided for the rewrite, they really shouldn&#39;t have anything to do with each other.</p>
<p>I still want canhazdb to come with the option of a lightweight http server, but I&#39;ll put it in at the end, and it&#39;ll be abstracted out a lot more.</p>
<h2 id="protocol-rewrite">Protocol rewrite</h2>
<p>The current stable version talks exclusively over JSON. So every time a node is asked to do something, it must receive the command in JSON and send a respones in JSON.</p>
<p>I still believe the biggest risk to the theory of canhazdb is network noise. Specially the noise of nodes that have no data to send back.</p>
<p>For example, when filtering on records (GET:/exampleCollection), a request is sent out to all nodes. In the current version is looks like this:</p>
<pre><code class="language-json">[10, {
  &quot;COMMAND&quot;: &quot;GET&quot;,
  &quot;COLLECTION_ID&quot;: &quot;exampleCollection&quot;,
  &quot;LIMIT&quot;: 10
}]
</code></pre>
<p>| n.b. the keys are shorted into numbers, but you get the idea.</p>
<p>In the latest version of <a href="https://github.com/markwylde/tcpocket">tcpocket</a>, I&#39;ve reduced the protocol to be a pure buffer. At least, for the first 3 bytes.</p>
<p>The above turns into:</p>
<pre><code class="language-text">&lt;Buffer&gt;[0x01, 0x00, 0x09, ...optionalBufferSegments]
</code></pre>
<p>The first two bytes make up an <code>Int16Array</code>, which resolves to the correlation id (a number between 3 and 65535), to allow for request and responses. The third byte is a command (an <code>Int8Array</code>) which is a number between 2 and 255.</p>
<p>Look back at the <code>GET</code> example above, this will make the request a little smaller.</p>
<p>But I feel the main benefit comes from the response, especially for nodes with no information to return.</p>
<p>Currently if a node does not have any results to send, it returns:</p>
<pre><code class="language-json">[10, {
  &quot;STATUS&quot;: &quot;200&quot;,
  &quot;DOCUMENTS&quot;: []
}]
</code></pre>
<p>With the new protocol, a node with no results to give can send:</p>
<pre><code class="language-text">&lt;Buffer&gt;[0x01, 0x00, 0x06]
</code></pre>
<p>This would mean for a filter that has to go out to a cluster of (for example) 10 nodes, if only 1 node has the document we are looking for, we have only wasted 9 bytes in the response.</p>
<p>There is much more to do on this, but I&#39;m pretty happy so far. I have even noticed an improvement in the test speeds.</p>
<h2 id="high-availability">High Availability</h2>
<p>With the rewrite, I&#39;ve currently implemented the <code>info</code>, <code>get</code>, and <code>post</code> commands.</p>
<h3 id="posts">POST&#39;s</h3>
<p>Performing a <code>POST</code> is one of the easiest commands on a database. The logic is basically, select $REPLICATION_FACTOR nodes at random (default 3), and insert the document.</p>
<p>Along with the document, each node is also told about all other nodes holding that replica.</p>
<h3 id="gets">GET&#39;s</h3>
<p>When performing a <code>GET</code>, the request still gets forwarded to every node in the cluster. However, now, a node will only return a document, if they are the first healthy node in the documents replica list.</p>
<p>So far this is all working really well, and I&#39;m happy with the performance (for now).</p>
<p>My next steps will be to implement locking again (as this is needed for PUT/PATCH/DELETE&#39;s), and then implement the rest of the commands.</p>
<h2 id="ejdb-vs-sqlite">EJDB vs SQLite</h2>
<p>One thing that&#39;s been bothering me about EJDB is the restriction on indexing.</p>
<p>Every field is indexed in canhazdb, and EJDB supports really good and fast indexing. However, you can only use them under certain conditions.</p>
<p>For this reason I&#39;m considering testing SQLite again, but using a different strategy from last time. I&#39;m concerned though that the overhead of a relational database engine will give a considerable performance loss. But I think it&#39;s worth a test.</p>
<p>Failing that, I might raise an issue with the EJDB author to find out any better solution for filtering on multiple indexes.</p>
</div><hr></section></div></div>
    </main>
  </body>
</html>
