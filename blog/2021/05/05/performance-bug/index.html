<html>
  <head>
    <title>Performance Bug - canhazdb</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/img/favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/atom-one-dark.min.css" integrity="sha512-Fcqyubi5qOvl+yCwSJ+r7lli+CO1eHXMaugsZrnxuU4DVpLYWXTVoHy55+mCb4VZpMgy7PBhV7IiymC0yu9tkQ==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js" integrity="sha512-zol3kFQ5tnYhL7PzGt0LnllHHVWRGt2bTCIywDiScVvLIlaDOVJ6sPdJTVi0m3rA660RT+yZxkkRzMbb1L8Zkw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/javascript.min.js" integrity="sha512-u9dJCEIlcxWLWzlBIBDAO98TI5r1yrxGwRY2vbqFdecd58lamsEgBt1p4sDNBncNUMDV5//WdywRHdhCLx0FJQ==" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/css/header.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />

    <script>
      document.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightBlock(block);
        });
      });

      function toggleBurgerMenu () {
        document.body.classList.toggle('burger-open');
      }
    </script>
    <base href="/" />

    <link rel="icon" type="image/png" href="/img/favicon.png" />
  </head>

  <body>
    <header class="menu-header">
      <div class="header-container">
        <div class="header-brand">
          <a href="/">
            <img src="/img/logo.svg" class="logo-icon" />
            <span>canhazdb</span>
          </a>
        </div>
        <div class="header-burger" onclick="toggleBurgerMenu()">
          <svg viewBox="0 0 100 80" width="25" height="25">
            <rect width="100" height="10"></rect>
            <rect y="30" width="100" height="10"></rect>
            <rect y="60" width="100" height="10"></rect>
          </svg>
        </div>
        
    <nav class="bugerable">
      <a href="/" false>Home</a>
      <a href="/docs" false>Docs</a>
      <a href="/blog" class="active">Blog</a>
      <a href="https://github.com/canhazdb/server/discussions">Community</a>
    </nav>
  
      </div>
    </header>

    <main>
      <div class="with-sidebar"><div class="thin content"><sidebar><ul><li><span>October 2021</span><ul><li><span>1</span><a href="/blog/2021/09/01/conflicts">Conflicts</a></li></ul></li><li><span>August 2021</span><ul><li><span>15</span><a href="/blog/2021/07/15/notify-and-license">Notify and license</a></li><li><span>11</span><a href="/blog/2021/07/11/ha-update">Ha update</a></li></ul></li><li><span>June 2021</span><ul><li><span>15</span><a href="/blog/2021/05/15/reducing-noise">Reducing noise</a></li><li><span>5</span><a href="/blog/2021/05/05/performance-bug">Performance bug</a></li><li><span>1</span><a href="/blog/2021/05/01/websockets-insert">Websockets insert</a></li></ul></li><li><span>May 2021</span><ul><li><span>23</span><a href="/blog/2021/04/23/stability">Stability</a></li></ul></li><li><span>February 2021</span><ul><li><span>8</span><a href="/blog/2021/01/08/introduction">Introduction</a></li></ul></li></ul></sidebar><section><div class="content-heading"><h1>Performance Bug<small>Published by <a href="https://markwylde.com" target="_blank">Mark Wylde</a> on 2021-06-05</small></h1><div class="content-info"><a target="_blank" class="edit-page" href="https://github.com/canhazdb/documentation/blob/master/content/blog/2021-06-05-performance-bug.md">Edit this page</a><em>Last updated: 2021-10-01</em></div></div><div><p>For the last few months <a href="https://docs.puzed.com/">Puzed</a>, which uses Canhazdb, has been slowing down as time passes. This bug would cause an instance to crash at least once a day.</p>
<p>I had tried on and off to debug this over the past six months, but my focus was mainly on the Puzed project. This is because Puzed has so much logic, scheduled jobs, healthchecks and more. I was certain there was a leak somewhere in that code.</p>
<p>But as I mentioned in my previous blog post, I wanted to stress test Canhazdb on it&#39;s own to see what it&#39;s limitations are.</p>
<p>Starting on Puzed, I added some metrics monitoring to the project. This resulted in the following:</p>
<h2 id="1-puzed-performance">1) Puzed Performance</h2>
<p><img src="/img/blog-performance-bug-1.png" alt="screenshot of metrics"></p>
<p>The above is a snapshot showing the different type of database requests, along with the average time (in milliseconds) it took to complete the request.</p>
<p>You can see, it gradually takes longer and longer to perform essentially the same number of queries.</p>
<h2 id="2-canhazdb-performance">2) Canhazdb Performance</h2>
<p><img src="/img/blog-performance-bug-2.png" alt="screenshot of metrics"></p>
<p>After a while drilling into the Puzed codebase, I decided to just trying the same metrics testing in a local Canhazdb instance instead.</p>
<p>To my surprise, Canhazdb was showing similar performance degregation.</p>
<p>Luckily, the first part of the stack I looked at, was the client. It didn&#39;t take too long to until I discovered <a href="https://github.com/canhazdb/client/commit/cc4e16c859231720bdbc87410ab47a2048221efc">a bug in the client</a>. Everytime a message is sent to the server, it waits for a response. Once it receives a response, I wasn&#39;t cleaning up the callbacks. This was resulting in a huge array that could never empty.</p>
<h2 id="3-performance-after-fix">3) Performance after fix</h2>
<p><img src="/img/blog-performance-bug-3.png" alt="screenshot of metrics"></p>
<p>Finally, with the fix inplace, it looks like the performance is stable and consistent.</p>
<h2 id="4-puzed-upgrade">4) Puzed upgrade</h2>
<p><img src="/img/blog-performance-bug-4.png" alt="screenshot of metrics"></p>
<p>Finally, I upgraded the Canhazdb client dependency in the Puzed API server. This resulted, not only in much lower response times, but the beta server is now up and running for much longer than normal, along with consistent, linear response times.</p>
</div><hr></section></div></div>
    </main>
  </body>
</html>
